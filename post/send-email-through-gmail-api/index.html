<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Dorin Adam - Send email through gmail api</title>

    <!-- Bootstrap Core CSS -->
    <link href="/assets/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="/assets/css/clean-blog.min.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/styles/solarized_light.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="index.html">Start Bootstrap</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    <li>
                        <a href="/about/">About</a>
                    </li>
                    <li>
                        <a href="/projects/">Projects</a>
                    </li>
                    <li>
                        <a href="/contact/">Contact</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
    <!-- Set your background image for this header on the line below. -->
    <header class="intro-header" style="background-image: url('coffee.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Sending Mail through the gmail Api</h1>
                        <h2 class="subheading">A journey: from mail() to Swiftmailer to PHPmailer and finally to the gmail Api. </h2>
                        <span class="meta">Or just skip to the <a href="#the-code-part">Code Part</a> </span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Post Content -->
    <article>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

                  <img src="/assets/img/wip.jpg" style="display:block;margin:0 auto;max-width:100%;" alt="">
   <!--                  <h2 class="section-heading">The Journey</h2>
                    <p>To boldly to where no man has gone before...</p>
                    <p>Not really... I just wanted to send a mail from a server to a user. I originally used the php mail function and of course that email was going straight to the spam folder of their email box.</p>
                    <p>This wasn't the ideal scenario, and the client was not happy.</p>
                    <p>Ok, granted, this sucked but it was only the php mail function... I haven't used anything fancy so I flexed my programming muscles (I used google) and I found a solution !</p>
                    <p>Enter Swiftmailer! witch I think is a very cool mail library. I fired up my local server opened the projected and implemente the new stuff i was supposed to implement. Now the emails were flying to inbox</p>

                <pre>
                <code class="php" style="background:transparent;">
 if (session_status() == PHP_SESSION_NONE) {
        session_start();
    }
    require_once (__DIR__.'/Jobs/google-api-php-client/src/Google/autoload.php');

    $client = new \Google_Client();
    $client->setClientId("334258235685-53mjg1lbmpvveh7u22if70thuols0p3g.apps.googleusercontent.com");
    $client->setClientSecret("KWH-AlOg-xDgoMNhO-P-mD9M");

    $client->setRedirectUri("http://www.caiet.info");
    $client->setAccessType('offline');
    $client->setApprovalPrompt('force');
    // dd($client);
    $client->addScope("https://mail.google.com/");
    $client->addScope("https://www.googleapis.com/auth/gmail.compose");
    $client->addScope("https://www.googleapis.com/auth/gmail.modify");
    $client->addScope("https://www.googleapis.com/auth/gmail.readonly");

    // $_REQUEST['code'] = "4/G_Uv_zNKBOuO7IPWqxz--7DQjh0LftLwA-nY3t5TrXk#"; //code and auth stuff to get tge gmail_access_token
    // $authUrl = $client->createAuthUrl();
    //     header("Location: $authUrl");
    //     die();
    // if (isset($_REQUEST['code'])) {
    //    //land when user authenticated
    //    $code = $_REQUEST['code'];
    //    $client->authenticate($code);

    //    $_SESSION['gmail_access_token'] = $client->getAccessToken();

    //  echo $_SESSION['gmail_access_token'];
    //  exit;
    //  die();
    //    header("Location:".url());
    // }
        // $authCode = trim(fgets(STDIN));
        // $accessToken = $client->authenticate($authCode);
        // dd($accessToken);//

    $_SESSION['gmail_access_token'] = '{"access_token":"ya29.8gH8a-P6k6pno2M_0i6XIivkm_ooTM5XcWMeGtpWPzey_W81aPahTa7Tzl_3keUj6C4i","token_type":"Bearer","expires_in":3600,"refresh_token":"1\/uIWdygsbP-u_v_l-_9XzIDQGwQ6wYz_fqNwGV_CkkmI","created":-9}';//1442568393

    //$isAccessCodeExpired = $client->isAccessTokenExpired();

    // die();
    //if (isset($_SESSION['gmail_access_token']) && !empty($_SESSION['gmail_access_token']) && $isAccessCodeExpired != 1) {
    if (isset($_SESSION['gmail_access_token']) && !empty($_SESSION['gmail_access_token']) ) {

        $client->setAccessToken($_SESSION['gmail_access_token']);
        $objGMail = new \Google_Service_Gmail($client);

        $strSubject = $subject;//'Αυτό είναι Test mail using GMail API' . date('M d, Y h:i:s A');

        $strRawMessage = "From: NoReply@caiet.info <no-reply@caiet.info>\r\n";
        $strRawMessage .= "To:<".$to.">\r\n";
        $strRawMessage .= 'Subject: =?utf-8?B?' . base64_encode($strSubject) . "?=\r\n";
        $strRawMessage .= "MIME-Version: 1.0\r\n";
        $strRawMessage .= "Content-Type: text/html;charset:utf-8\r\n";
        $strRawMessage .= 'Content-Transfer-Encoding: quoted-printable' . "\r\n\r\n";//
        $strRawMessage .= $template;//"this <b>is a</b> τηισ είς α τεστ tes2t!\r\n";

        //Users.messages->send - Requires -> Prepare the message in message/rfc822
        try {
            // The message needs to be encoded in Base64URL
            $mime = strtr(base64_encode($strRawMessage), '+/', '-_');
            $msg = new \Google_Service_Gmail_Message();
            $msg->setRaw($mime);

            //The special value **me** can be used to indicate the authenticated user.
            $objSentMsg = $objGMail->users_messages->send("me", $msg);

            // print('Message sent object');
            // print($objSentMsg);

        } catch (Exception $e) {
            print($e->getMessage());
            unset($_SESSION['gmail_access_token']);
        }
    }
    else {
        // Failed Authentication
        if (isset($_REQUEST['error'])) {
            //header('Location: ./index.php?error_code=1');
            echo "error auth";
        }
        else{
            // Redirects to google for User Authentication
            $authUrl = $client->createAuthUrl();
            header("Location: $authUrl");
        }
    }


    }
                                    </code>
                </pre>



                    <blockquote>The dreams of yesterday are the hopes of today and the reality of tomorrow. Science has not yet mastered prophecy. We predict too much for the next year and yet far too little for the next ten.</blockquote>

                    <p>Spaceflights cannot be stopped. This is not the work of any one man or even a group of men. It is a historical process which mankind is carrying out in accordance with the natural laws of human development.</p>

                    <h2 class="section-heading">Reaching for the Stars</h2>

                    <p>As we got further and further away, it [the Earth] diminished in size. Finally it shrank to the size of a marble, the most beautiful you can imagine. That beautiful, warm, living object looked so fragile, so delicate, that if you touched it with a finger it would crumble and fall apart. Seeing this has to change a man.</p>

                    <a href="#" id="the-code-part">
                        <img class="img-responsive" src="img/post-sample-image.jpg" alt="">
                    </a>
                    <span class="caption text-muted">To go places and do things that have never been done before – that’s what living is all about.</span>

                    <p>Space, the final frontier. These are the voyages of the Starship Enterprise. Its five-year mission: to explore strange new worlds, to seek out new life and new civilizations, to boldly go where no man has gone before.</p>

                    <p>As I stand out here in the wonders of the unknown at Hadley, I sort of realize there’s a fundamental truth to our nature, Man must explore, and this is exploration at its greatest.</p>

                    <p>Placeholder text by <a href="http://spaceipsum.com/">Space Ipsum</a>. Photographs by <a href="https://www.flickr.com/photos/nasacommons/">NASA on The Commons</a>.</p> -->
                </div>
            </div>
        </div>
    </article>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                        <li>
                            <a href="https://twitter.com/IdeiVirale" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="https://www.facebook.com/adamoctav" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="https://github.com/adam-dorin" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    </ul>
                    <p class="copyright text-muted">Copyright &copy; Adam Dorin 2015</p>
                </div>
            </div>
        </div>

    </footer>
    <!-- jQuery -->
    <script src="/assets/js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/assets/js/bootstrap.min.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="/assets/js/clean-blog.min.js"></script>

</body>

</html>
